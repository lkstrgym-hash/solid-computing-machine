<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>چت روم P2P با PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

    <h1>چت روم همتا به همتا (Room: 666666)</h1>
    <div id="status">وضعیت: در حال اتصال...</div>
    <div id="messages"></div>

    <input type="text" id="messageInput" placeholder="پیام خود را بنویسید">
    <button onclick="sendMessage()">ارسال</button>

    <script>
        // آیدی اتاق یا سرور
        const ROOM_ID = '666666';
        let peer = null;
        let connections = {}; // برای ذخیره اتصالات فعال

        // --- ۱. راه اندازی PeerJS ---
        // برای این مثال، از سرور پیش‌فرض PeerJS استفاده می‌کنیم.
        peer = new Peer({
            host: 'peerjs-server.example.com', // آدرس سرور PeerJS خودتان (اگر دارید)
            secure: true, // اگر از https استفاده می‌کنید
            port: 443 // پورت سرور PeerJS
            // اگر از سرور پیش‌فرض استفاده می‌کنید، نیازی به host و port نیست
        });

        peer.on('open', (id) => {
            document.getElementById('status').textContent = `وضعیت: Peer من ساخته شد. ID من: ${id}`;
            
            // --- ۲. تلاش برای اتصال به ROOM_ID (نفر اول در اتاق) ---
            if (id !== ROOM_ID) {
                // اگر Peer ID من با ID اتاق یکی نیست، سعی می‌کنم به ROOM_ID متصل شوم.
                // اگر نفر اول قبلا با ID=666666 متصل شده باشد، این اتصال برقرار می‌شود.
                connectToPeer(ROOM_ID);
            }
        });

        // --- ۳. دریافت درخواست اتصال جدید (نفر اول در اتاق) ---
        peer.on('connection', (conn) => {
            document.getElementById('status').textContent = `وضعیت: کاربر جدیدی به اتاق متصل شد.`;
            connections[conn.peer] = conn;
            setupConnectionEvents(conn);
        });

        peer.on('error', (err) => {
            console.error(err);
            document.getElementById('status').textContent = `وضعیت: خطایی رخ داد: ${err.type}`;
        });


        // --- تابع اتصال به یک همتا ---
        function connectToPeer(targetPeerId) {
            const conn = peer.connect(targetPeerId, {
                reliable: true // اطمینان از تحویل پیام
            });
            
            conn.on('open', () => {
                document.getElementById('status').textContent = `وضعیت: با موفقیت به ${targetPeerId} متصل شدم.`;
                connections[targetPeerId] = conn;
                setupConnectionEvents(conn);
            });
        }
        
        // --- تابع مدیریت رویدادهای یک اتصال ---
        function setupConnectionEvents(conn) {
            conn.on('data', (data) => {
                displayMessage(`پیام از ${conn.peer}: ${data.message}`, data.userName);
            });
            conn.on('close', () => {
                displayMessage(`اتصال با ${conn.peer} قطع شد.`, 'سیستم');
                delete connections[conn.peer];
            });
        }
        
        // --- تابع ارسال پیام ---
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value;
            if (!message) return;

            const dataToSend = {
                message: message,
                userName: localStorage.getItem('userName') || 'ناشناس'
                // می‌توانید لینک تصویر را هم اینجا اضافه کنید
            };

            // ارسال پیام به تمام همتاهای متصل
            for (let id in connections) {
                connections[id].send(dataToSend);
            }

            // نمایش پیام خودمان
            displayMessage(`من: ${message}`, dataToSend.userName);
            input.value = '';
            
            // ذخیره چت در Local Storage (به صورت ناقص در این مثال)
            saveMessageToLocalStorage(dataToSend); 
        }

        // --- توابع کمکی برای نمایش و ذخیره ---
        function displayMessage(text, senderName) {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = `[${senderName}] ${text}`;
            document.getElementById('messages').appendChild(msgDiv);
        }
        
        function saveMessageToLocalStorage(data) {
             // پیاده‌سازی کامل ذخیره‌سازی چت‌های قبلی
             // (مانند خواندن آرایه چت، اضافه کردن پیام جدید، و ذخیره مجدد)
        }
        
        // --- تنظیمات کاربر (نام و تصویر) ---
        function checkAndSetUserProfile() {
            if (!localStorage.getItem('userName')) {
                const userName = prompt("لطفاً نام خود را وارد کنید:");
                // const userImage = prompt("لطفاً لینک تصویر پروفایل خود را وارد کنید:");
                if (userName) {
                    localStorage.setItem('userName', userName);
                    // localStorage.setItem('userImage', userImage);
                    alert("پروفایل شما ذخیره شد!");
                }
            }
        }
        
        // اجرای تابع تنظیمات هنگام بارگذاری صفحه
        checkAndSetUserProfile();
        
        // اینجا می‌توانید کد مربوط به بارگذاری چت‌های قبلی از Local Storage را اضافه کنید
        
    </script>
</body>
</html>
